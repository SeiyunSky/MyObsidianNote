自定义注解是 Java 中非常强大的特性，它可以让你在不改变代码逻辑的情况下，为代码添加元数据信息，并通过 AOP 等方式实现各种横切功能。下面我将通过一个完整示例，教你如何实现类似`@SentinelRiskControl`的自定义注解。

## 一、创建自定义注解步骤

### 1. 定义注解类

首先创建一个注解类，使用`@interface`关键字定义：
```java
import java.lang.annotation.*;

/**
 * 自定义Sentinel风控注解
 */
// 注解作用目标：方法
@Target({ElementType.METHOD})
// 注解保留策略：运行时（可以通过反射获取）
@Retention(RetentionPolicy.RUNTIME)
// 生成JavaDoc时会包含该注解信息
@Documented
// 允许子类继承父类的注解
@Inherited
public @interface SentinelRiskControl {

    // 资源名称（必填参数）
    String resourceName();
    
    // 风控接口地址（可选参数，有默认值）
    String riskControlUrl() default "";
    
    // 规则类型（可选参数，默认是限流）
    String ruleType() default "FLOW";
    
    // 降级返回值（可选参数，默认JSON）
    String fallbackValue() default "{\"code\":503,\"message\":\"服务暂时不可用\"}";
}
```

### 2. 注解参数说明

- 注解的参数声明格式：`类型 参数名() [default 默认值];`
- 如果没有默认值，使用注解时必须显式指定该参数
- 可以定义多种类型的参数：基本类型、String、Class、枚举、其他注解等

## 二、创建 AOP 切面处理注解

注解本身只是元数据，需要通过 AOP 切面来实现具体功能：
```java
import com.alibaba.csp.sentinel.Entry;
import com.alibaba.csp.sentinel.SphU;
import com.alibaba.csp.sentinel.slots.block.BlockException;
import com.alibaba.fastjson.JSONObject;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Pointcut;
import org.aspectj.lang.reflect.MethodSignature;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;

import javax.annotation.Resource;
import java.lang.reflect.Method;

/**
 * 注解切面处理器，实现注解的具体逻辑
 */
@Aspect  // 标识这是一个切面类
@Component  // 让Spring管理该Bean
public class SentinelRiskControlAspect {

    // 注入RestTemplate用于调用风控接口
    @Resource
    private RestTemplate restTemplate;

    /**
     * 定义切点：匹配所有添加了@SentinelRiskControl注解的方法
     */
    @Pointcut("@annotation(com.example.annotation.SentinelRiskControl)")
    public void sentinelPointcut() {}

    /**
     * 环绕通知：在目标方法执行前后执行逻辑
     */
    @Around("sentinelPointcut() && @annotation(sentinelAnnotation)")
    public Object around(ProceedingJoinPoint joinPoint, SentinelRiskControl sentinelAnnotation) throws Throwable {
        // 1. 获取注解参数
        String resourceName = sentinelAnnotation.resourceName();
        String riskUrl = sentinelAnnotation.riskControlUrl();
        String fallbackValue = sentinelAnnotation.fallbackValue();
        
        Entry entry = null;
        try {
            // 2. 使用Sentinel监控资源
            entry = SphU.entry(resourceName);
            
            // 3. 执行目标方法（业务逻辑）
            return joinPoint.proceed();
            
        } catch (BlockException e) {
            // 4. 触发限流/降级规则时的处理
            System.out.println("触发Sentinel规则：" + e.getMessage());
            
            // 5. 调用风控接口
            if (!riskUrl.isEmpty()) {
                callRiskControlApi(riskUrl, resourceName, e);
            }
            
            // 6. 返回降级结果
            return handleFallback(joinPoint, fallbackValue);
            
        } finally {
            // 7. 释放Sentinel资源
            if (entry != null) {
                entry.exit();
            }
        }
    }

    /**
     * 调用风控接口
     */
    private void callRiskControlApi(String url, String resource, BlockException e) {
        try {
            JSONObject param = new JSONObject();
            param.put("resource", resource);
            param.put("exception", e.getClass().getSimpleName());
            param.put("message", e.getMessage());
            param.put("timestamp", System.currentTimeMillis());
            
            restTemplate.postForObject(url, param, String.class);
        } catch (Exception ex) {
            System.err.println("调用风控接口失败：" + ex.getMessage());
        }
    }

    /**
     * 处理降级逻辑，将JSON字符串转换为目标返回类型
     */
    private Object handleFallback(ProceedingJoinPoint joinPoint, String fallbackJson) {
        try {
            // 获取目标方法的返回类型
            MethodSignature signature = (MethodSignature) joinPoint.getSignature();
            Method method = signature.getMethod();
            Class<?> returnType = method.getReturnType();
            
            // 将JSON转换为返回类型的对象
            return JSONObject.parseObject(fallbackJson, returnType);
        } catch (Exception e) {
            System.err.println("降级处理失败：" + e.getMessage());
            return null;
        }
    }
}
```
## 三、使用自定义注解

在业务方法上添加自定义注解，就可以实现功能了：
```java
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class UserController {

    @PostMapping("/login")
    // 使用自定义注解
    @SentinelRiskControl(
        resourceName = "userLogin",  // 资源名称
        riskControlUrl = "http://risk-service/log",  // 风控接口
        ruleType = "DEGRADE",  // 规则类型
        fallbackValue = "{\"code\":503,\"message\":\"登录太频繁，请稍后再试\",\"data\":null}"  // 降级返回值
    )
    public Result login(
            @RequestParam String username,
            @RequestParam String password) {
        
        // 业务逻辑：验证用户名密码
        if ("admin".equals(username) && "123456".equals(password)) {
            return Result.success("登录成功", "token_123456");
        } else {
            return Result.fail("用户名或密码错误");
        }
    }
}
```
## 四、必要的依赖配置

如果是 Spring Boot 项目，需要添加以下依赖（pom.xml）：
```xml
<!-- Spring AOP 依赖 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-aop</artifactId>
</dependency>

<!-- Sentinel 核心依赖 -->
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-core</artifactId>
    <version>1.8.6</version>
</dependency>

<!-- FastJSON 用于JSON处理 -->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>fastjson</artifactId>
    <version>1.2.83</version>
</dependency>

<!-- Spring Web 依赖（如果需要调用接口） -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
```
## 五、工作原理总结

1. **定义注解**：通过`@interface`创建注解，并定义参数
2. **创建切面**：使用 AOP 的`@Aspect`定义切面，通过`@Pointcut`指定注解作用的位置
3. **实现逻辑**：在`@Around`通知中编写具体功能（如 Sentinel 监控、风控调用、降级处理）
4. **使用注解**：在目标方法上添加注解，传入必要参数
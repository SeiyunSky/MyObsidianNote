## 功能分析：
- 检查用户名是否存在
- 注册用户
- 修改用户
- 根据用户名查询用户
- 用户登录
- 用户退出
- 注销用户
- 检查用户是否登录

## 防止检查用户名缓存穿透
**解决方法1：放入Redis中**
- 数据初始化任务
- 读取数据库记录
- 将数据库记录由DB同步至RedisCache中
 ![[Pasted image 20250722144709.png|200]]
 **存在问题：**
 - 是否设置数据有效期？只能设置为永久数据
 - 若为永久则占用Redis内存过高
 
**解决方法2：使用布隆过滤器**
![[Pasted image 20250722164208.png|400]]

布隆过滤器是一种数据结构，用于快速判断一个元素是否存在于一个集合中。具体来说，布隆过滤器**包含一个位数组和一组哈希函数**。位数组的初始值全部置为 0。在插入一个元素时，将该元素经过多个哈希函数映射到位数组上的多个位置，并将这些位置的值置为 1
在查询一个元素是否存在时，**会将该元素经过多个哈希函数映射到位数组上的多个位置**，如果所有位置的值都为 1，则认为元素存在；如果存在任一位置的值为 0，则认为元素不存在。
![[Pasted image 20250722164457.png|400]]
- 节省内存
- 高效判断一个元素是否属于一个大规模集合

**缺点是存在误判可能性：**
- 布隆过滤器要设置初始容量。容量设置越大，冲突几率越低。
- 布隆过滤器会设置预期的误判值。
但是由于用户名并非重要数据，因此当发生误判时，对用户名稍作修改即可。

![[Pasted image 20250722165059.png|500]]
#### 引入依赖
```JAVA
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>

<dependency>
    <groupId>org.redisson</groupId>
    <artifactId>redisson-spring-boot-starter</artifactId>
</dependency>
```
#### 创建布隆过滤器实例
```JAVA
import org.redisson.api.RBloomFilter;
import org.redisson.api.RedissonClient;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * 布隆过滤器配置
 */
@Configuration
public class RBloomFilterConfiguration {

    /**
     * 防止用户注册查询数据库的布隆过滤器
     */
    @Bean
    public RBloomFilter<String> userRegisterCachePenetrationBloomFilter(RedissonClient redissonClient) {
        RBloomFilter<String> cachePenetrationBloomFilter = redissonClient.getBloomFilter("xxx");
        cachePenetrationBloomFilter.tryInit(0, 0);
        return cachePenetrationBloomFilter;
    }
}
```

tryInit 有两个核心参数：
- expectedInsertions：预估布隆过滤器存储的元素长度。
- falseProbability：运行的误判率。

错误率越低，位数组越长，布隆过滤器的内存占用越大。
错误率越低，散列 Hash 函数越多，计算耗时较长。

**在代码中使用：**
```JAVA
private final RBloomFilter<String> userRegisterCachePenetrationBloomFilter;
```
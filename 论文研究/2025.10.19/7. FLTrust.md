**21年论文**
**核心思路**
在FLTrust中设计了一种新的拜占庭鲁棒聚合规则，以融入信任根。模型更新可视为一个向量，其特征在于方向和大小。
攻击者可以操纵恶意客户端上本地模型更新的方向和大小。
因此，聚合规则在计算全局模型更新时会同时考虑方向和大小。
具体来说，服务器首先为本地模型更新分配一个信任分数（TS），如果本地模型更新的方向与服务器模型更新的方向更相似，那么信任分数就会更高。
形式上，我们**使用本地模型更新与服务器模型更新之间的余弦相似度来衡量它们方向的相似性**。
然而，仅靠余弦相似度是不够的，因为余弦相似度分数为负的本地模型更新仍可能对聚合后的全局模型更新产生负面影响。因此，
**使用常用的ReLU操作对余弦相似度分数进一步裁剪。经过ReLU裁剪的余弦相似度就是我们的信任分数**。
然后，**FLTrust通过缩放使每个本地模型更新的大小与服务器模型更新的大小相同，从而对其进行归一化**。
这种归一化本质上是**将每个本地模型更新投影到服务器模型更新所在向量空间中的同一个超球面上**，这限制了具有较大幅度的受污染本地模型更新的影响。最后，**FLTrust将经过归一化的本地模型更新以其信任分数为权重进行平均，作为全局模型更新**，用于更新全局模型。

**算法概述**
计算TS分数进行归一化，再根据Ts分数聚合
![[Pasted image 20251025161150.png]]
显然，这里的 **root dataset** 违背了[点我](obsidian://open?vault=Note&file=%E8%AE%BA%E6%96%87%E7%A0%94%E7%A9%B6%2F2025.10.9%2F1%E3%80%81FedAvg)数据集中化的隐私问题。
![[Pasted image 20251025162614.png|300]]

**数学假设**：
**强凸且光滑**——期望损失函数F(w)在参数空间$\Theta$上是$\mu$- 强凸且可微的，其梯度满足L-Lipschit 连续性。
![[Pasted image 20251025163724.png|300]]
L-光滑在概率下的表达
![[Pasted image 20251025163753.png|500]]

**损失函数在全局最优处有界**
![[Pasted image 20251025164053.png]]
**数据集来源为数据分布X**

**定理 1：FLTrust 的鲁棒收敛性 (Robust Convergence of FLTrust)**
**定理条件**
1.  **假设 1–3** 均成立。
2.  FLTrust 算法的超参数设置为：
    *   本地迭代轮数 $R_l = 1$
    *   参数 $\beta = 1$
3.  恶意客户端的数量可以是任意多个。
**定理结论**
在上述条件成立的情况下，FLTrust 算法在遭受攻击时，第 $t$ 轮迭代的全局模型 $w^t$ 与无攻击情况下的最优全局模型 $w^*$ 之间的差异是有界的。具体地，存在一个概率至少为 $1 - \delta$ 的事件，在该事件下，有如下不等式成立：

$$
\| w^t - w^* \| \leq (1 - \rho)^t \| w^0 - w^* \| + \frac{12\alpha \Delta_1}{\rho}
$$
**参数与变量定义 (Definitions)**

| 符号       | 描述                            |
| :------- | :---------------------------- |
| $w^t$    | 第 $t$ 轮迭代时的全局模型参数向量           |
| $w^*$    | 无攻击情况下的最优全局模型参数向量             |
| $w^0$    | 全局模型的初始参数向量                   |
| $\alpha$ | 全局学习率 (Global learning rate)  |
| $\delta$ | 置信参数，定理结论以至少 $1-\delta$ 的概率成立 |
| $d$      | 全局模型参数 $w$ 的维度                |
| $D_0$    | 服务器持有的可信根数据集的大小               |


**常数 $\rho$ 的定义：**
$$
\rho = 1 - \left( \sqrt{1 - \frac{\mu^2}{4L^2}} + 24\alpha \Delta_2 + 2\alpha L \right)
$$
其中，$\mu$ 和 $L$ 是与损失函数性质相关的常数，$\Delta_2$ 是一个与根数据集大小、模型维度等相关的正常数。

**误差项 $\Delta_1$ 的定义：**
$$
\Delta_1 = \sigma_1 \sqrt{\frac{2}{|D_0|}} \sqrt{d \log 6 + \log\left(\frac{3}{\delta}\right)}
$$
其中，$\sigma_1$ 是来自**假设 2** 的次指数分布参数。
**空间约束：**
- $L_2 = \max\{L, L_1\}$，其中 $L_1$ 是一个正常数。
- 参数空间 $\Theta$ 是有界的，存在正常数 $r$，使得对任意 $w \in \Theta$，有 $\| w - w^* \| \leq r\sqrt{d}$。
 **极限行为 (Asymptotic Behavior)**
当 $|1 - \rho| < 1$时，模型的极限误差满足：
$$
\lim_{t \to \infty} \| w^t - w^* \| \leq \frac{12\alpha \Delta_1}{\rho}
$$

---
### 附录A：定理1的证明

在证明定理1之前，我们首先重新阐述FLTrust算法，并证明若干引理。需要说明的是，在我们设定的 $R_l=1$（本地迭代次数为1）场景下，仅联合学习率 $\alpha \cdot \beta$ 会对FLTrust的训练过程产生影响。因此，给定一个联合学习率，我们始终可以将 $\beta$ 设为1，并令 $\alpha$ 直接表示联合学习率。在这种情况下，客户端的本地模型更新与服务器的模型更新，分别等价于客户端和服务器对应数据上损失函数的负梯度。为简化符号，下文将用 $g_i$ 和 $g_0$ 分别表示第 $i$ 个客户端的梯度与服务器的梯度。我们用 $S$ 表示在第 $t$ 轮全局迭代中，余弦相似度 $c_i$ 为正的客户端集合；
令 
$$\overline{g}_i=\frac{\left|g_0\right|}{\left|g_i\right|} \cdot g_i$$，
$$\varphi_i=\frac{ReLU(c_i)}{\sum_{j \in S} ReLU(c_j)}=\frac{c_i}{\sum_{j \in S} c_j}$$
（其中 $c_i$ 为第 $i$ 个本地模型更新与服务器模型更新的余弦相似度）。
此时，可由式（4）得到全局梯度 $g$，并基于此推导以下引理。
#### 引理1
对于任意数量的恶意客户端，在每一轮迭代中，全局梯度 $g$ 与期望损失函数梯度 $\nabla F(w)$ 之间的距离满足有界性，即：
​**​FLTrust 聚合梯度的总误差，最多是服务器梯度误差的 3 倍，加上真实梯度大小的 2 倍。**
$$| g - \nabla F(w) | \leq 3 | g_0 - \nabla F(w) | + 2 | \nabla F(w) |$$
**证明：**
我们通过以下等式与不等式推导完成证明：
$$
\begin{aligned}
| g - \nabla F(w) | &= \left| \sum_{i \in S} \varphi_i \overline{g}_i - \nabla F(w) \right| \\
&\stackrel{(a)}{\leq} \left| \sum_{i \in S} \varphi_i \overline{g}_i - g_0 \right| + \left| g_0 - \nabla F(w) \right| \\
&\stackrel{(b)}{\leq} \sum_{i \in S} \varphi_i \left| \overline{g}_i - g_0 \right| + \left| g_0 - \nabla F(w) \right| \\
&\stackrel{(c)}{\leq} \sum_{i \in S} \varphi_i \left( \left| \overline{g}_i \right| + \left| g_0 \right| \right) + \left| g_0 - \nabla F(w) \right| \\
&= \sum_{i \in S} \varphi_i \left( \left| g_0 \right| + \left| g_0 \right| \right) + \left| g_0 - \nabla F(w) \right| \\
&= 2 \left| g_0 \right| \sum_{i \in S} \varphi_i + \left| g_0 - \nabla F(w) \right| \\
&= 2 \left| g_0 \right| + \left| g_0 - \nabla F(w) \right| \\
&\leq 2 \left( \left| g_0 - \nabla F(w) \right| + \left| \nabla F(w) \right| \right) + \left| g_0 - \nabla F(w) \right| \\
&= 3 | g_0 - \nabla F(w) | + 2 | \nabla F(w) |
\end{aligned}
$$
其中，
$(a)$ 成立的原因是对于 $i \in S$，有 $\langle \overline{g}_i, g_0 \rangle > 0$；
$(b)$ 基于FLTrust的归一化操作——本地模型更新被缩放至与服务器模型更新幅度相同，即 $\left| \overline{g}_i \right| = \left| g_0 \right|$
$(c)$ 则是利用了三角不等式与 $\sum_{i \in S} \varphi_i = 1$ 的性质。

#### 引理2
**这里是联邦学习正常情况下肯定收敛**
假设假设1成立，若将学习率设为 $\alpha = \mu/(2L^2)$，则对于任意 $t \geq 1$ 轮全局迭代，有：
$$\left| w^t - w^* \right|^2 \leq \left( 1 - \mu^2/(4L^2) \right) \left| w^{t-1} - w^* \right|^2$$
**证明：**
由于最优全局模型 $w^*$ 满足 $\nabla F(w^*) = 0$，结合假设1中期望损失函数的强凸性与梯度的Lipschitz连续性，可得：
$$F(w^*) \geq F(w^{t-1}) + \langle \nabla F(w^{t-1}), w^* - w^{t-1} \rangle + \frac{\mu}{2} \left| w^* - w^{t-1} \right|^2$$
同时，由梯度的Lipschitz连续性有：
$$\left| \nabla F(w^{t-1}) - \nabla F(w^*) \right| \leq L \left| w^{t-1} - w^* \right|$$
即 $$\left| \nabla F(w^{t-1}) \right| \leq L \left| w^{t-1} - w^* \right|$$
将**全局模型更新规则 $w^t = w^{t-1} - \alpha \nabla F(w^{t-1})$ 代入范数计算**：
$$
\begin{aligned}
\left| w^t - w^* \right|^2 &= \left| w^{t-1} - \alpha \nabla F(w^{t-1}) - w^* \right|^2 \\
&= \left| (w^{t-1} - w^*) - \alpha \nabla F(w^{t-1}) \right|^2 \\
&= \left| w^{t-1} - w^* \right|^2 - 2\alpha \langle w^{t-1} - w^*, \nabla F(w^{t-1}) \rangle + \alpha^2 \left| \nabla F(w^{t-1}) \right|^2
\end{aligned}
$$
由强凸性不等式变形可得 $\langle w^{t-1} - w^*, \nabla F(w^{t-1}) \rangle \geq \frac{\mu}{2} \left| w^{t-1} - w^* \right|^2$，将其与 $\left| \nabla F(w^{t-1}) \right| \leq L \left| w^{t-1} - w^* \right|$ 代入上式：
$$
\begin{aligned}
\left| w^t - w^* \right|^2 &\leq \left| w^{t-1} - w^* \right|^2 - 2\alpha \cdot \frac{\mu}{2} \left| w^{t-1} - w^* \right|^2 + \alpha^2 L^2 \left| w^{t-1} - w^* \right|^2 \\
&= \left| w^{t-1} - w^* \right|^2 - \alpha \mu \left| w^{t-1} - w^* \right|^2 + \alpha^2 L^2 \left| w^{t-1} - w^* \right|^2 \\
&= \left( 1 - \alpha \mu + \alpha^2 L^2 \right) \left| w^{t-1} - w^* \right|^2
\end{aligned}
$$
将 $\alpha = \mu/(2L^2)$ 代入括号内的表达式：
$$1 - \frac{\mu}{2L^2} \cdot \mu + \left( \frac{\mu}{2L^2} \right)^2 L^2 = 1 - \frac{\mu^2}{2L^2} + \frac{\mu^2}{4L^2} = 1 - \frac{\mu^2}{4L^2}$$
因此，$$\left| w^t - w^* \right|^2 \leq \left( 1 - \mu^2/(4L^2) \right) \left| w^{t-1} - w^* \right|^2$$，引理2得证。

#### 引理3
**根节点得出的模型的误差**
假设假设2成立，对于任意 $\delta \in (0,1)$ 和任意 $w \in \Theta$，令 $$\Delta_3 = \sqrt{2}\sigma_2 \sqrt{(d\log 6 + \log(3/\delta))/|D_0|}$$（其中 $\Delta_1 \leq \sigma_1^2/\gamma_1$，$\Delta_3 \leq \sigma_2^2/\gamma_2$），则有：
$$\left| \frac{1}{|D_0|} \sum_{X_i \in D_0} \nabla f(X_i, w) - \nabla F(w) \right| \leq 8\Delta_2 \left| w - w^* \right| + 4\Delta_1$$

**证明：**
我们首先证明第一个不等式，第二个不等式的证明过程类似，此处省略。设 $V = \{v_1, v_2, \cdots, v_{N_{1/2}}\}$ 为单位球面 $B_2$ 的一个 $1/2$-覆盖（即对于单位球面上任意向量，都存在 $V$ 中向量与之距离不超过 $1/2$）。由文献[12]、[39]可知，$\log N_{1/2} \leq d\log 6$，且满足：
$$\left| \frac{1}{|D_0|} \sum_{X_i \in D_0} \nabla f(X_i, w^*) - \nabla F(w^*) \right| \leq 2\sup_{v \in V} \left\{ \left\langle \frac{1}{|D_0|} \sum_{X_i \in D_0} \nabla f(X_i, w^*) - \nabla F(w^*) , v \right\rangle \right\}$$
根据次指数随机变量的集中不等式[40]，当假设2与 $\Delta_1 \leq \sigma_1^2/\gamma_1$ 的条件成立时，有：
$$\Pr\left\{ \left\langle \frac{1}{|D_0|} \sum_{X_i \in D_0} \nabla f(X_i, w^*) - \nabla F(w^*) , v \right\rangle \geq \Delta_1 \right\} \leq \exp\left( -|D_0|\Delta_1^2/(2\sigma_1^2) \right)$$
对 $V$ 中所有向量取联合界，并结合上述覆盖不等式，可得：
$$\Pr\left\{ \left| \frac{1}{|D_0|} \sum_{X_i \in D_0} \nabla f(X_i, w^*) - \nabla F(w^*) \right| \leq 2\Delta_1 \right\} \geq 1 - \delta/3$$
通过类似推导，可证明梯度差相关项的有界性，最终结合三角不等式与覆盖性质，可得 $$\left| \frac{1}{|D_0|} \sum_{X_i \in D_0} \nabla f(X_i, w) - \nabla F(w) \right| \leq 8\Delta_2 \left| w - w^* \right| + 4\Delta_1$$，引理3得证。

#### 定理1的证明
$$
\| w^t - w^* \| \leq (1 - \rho)^t \| w^0 - w^* \| + \frac{12\alpha \Delta_1}{\rho}
$$
结合上述引理，我们对第 $t$ 轮全局迭代的模型差异进行推导：
$$
\begin{aligned}
\left| w^t - w^* \right| &= \left| w^{t-1} - \alpha g^{t-1} - w^* \right| \\
&= \left| (w^{t-1} - w^*) - \alpha g^{t-1} \right| \\
&= \left| (w^{t-1} - w^*) - \alpha \nabla F(w^{t-1}) + \alpha (\nabla F(w^{t-1}) - g^{t-1}) \right| \\
&\leq \left| (w^{t-1} - w^*) - \alpha \nabla F(w^{t-1}) \right| + \alpha \left| \nabla F(w^{t-1}) - g^{t-1} \right|
\end{aligned}
$$
由引理1可知 $\left| g^{t-1} - \nabla F(w^{t-1}) \right| \leq 3\left| g_0^{t-1} - \nabla F(w^{t-1}) \right| + 2\left| \nabla F(w^{t-1}) \right|$，结合引理2中 $$\left| (w^{t-1} - w^*) - \alpha \nabla F(w^{t-1}) \right| \leq \sqrt{1 - \mu^2/(4L^2)} \left| w^{t-1} - w^* \right|$$，以及引理3中 $$\left| g_0^{t-1} - \nabla F(w^{t-1}) \right| \leq 8\Delta_2 \left| w^{t-1} - w^* \right| + 4\Delta_1$$，代入可得：
$$
\begin{aligned}
\left| w^t - w^* \right| &\leq \sqrt{1 - \mu^2/(4L^2)} \left| w^{t-1} - w^* \right| + \alpha \left( 3(8\Delta_2 \left| w^{t-1} - w^* \right| + 4\Delta_1) + 2L \left| w^{t-1} - w^* \right| \right) \\
&= \left( \sqrt{1 - \mu^2/(4L^2)} + 24\alpha \Delta_2 + 2\alpha L \right) \left| w^{t-1} - w^* \right| + 12\alpha \Delta_1
\end{aligned}
$$
令 $\rho = 1 - \left( \sqrt{1 - \mu^2/(4L^2)} + 24\alpha \Delta_2 + 2\alpha L \right)$，通过递归展开上述不等式，可得：
$$\left| w^t - w^* \right| \leq (1 - \rho)^t \left| w^0 - w^* \right| + \frac{12\alpha \Delta_1}{\rho}$$
当 $|1 - \rho| < 1$ 时，$\lim_{t \to \infty} (1 - \rho)^t = 0$，因此 $\lim_{t \to \infty} \left| w^t - w^* \right| \leq \frac{12\alpha \Delta_1}{\rho}$。
综上，定理1得证。
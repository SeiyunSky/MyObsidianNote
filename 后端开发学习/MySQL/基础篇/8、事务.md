**@Transactional** Mybatis里直接在服务层加个这个注解就行

事务是一组操作的集合，不可分割，会把所有操作作为一个整体向系统提交或撤销操作请求，要么同时成功，要么同时失败。
- ​**​原子性(Atomicity)​**​：事务中的所有操作要么全部完成，要么全部不执行
- ​**​一致性(Consistency)​**​：事务执行前后，数据库从一个一致状态变为另一个一致状态
- ​**​隔离性(Isolation)​**​：并发事务之间互不干扰
- ​**​持久性(Durability)​**​：事务提交后，对数据库的修改是永久性的

```mysql
MYSQL默认开启自动提交模式
-- 查看当前自动提交状态
SELECT @@autocommit;

-- 关闭自动提交（0=关闭，1=开启）
SET autocommit = 0;

开启事务
START TRANSACTION;
-- 或者
BEGIN;

可以设置保存点，也可以 ROLLBACK TO 这个保存点
SAVEPOINT savepoint1;

提交事务
COMMIT;

回滚事务
ROLLBACK;
```

### 并发事务问题
**脏读**：一个事务读到另外一个事务还没有提交的数据
**不可重复读**：一个事务先后读取同一条记录，但两次读取的数据不同
**幻读**：一个事务按照条件查询数据时，没有对应的数据行，但插入数据时，发现数据已存在了。

### 事务隔离级别

| 隔离级别                | 脏读  | 不可重复读 | 幻读  |
| ------------------- | --- | ----- | --- |
| Read uncommitted    | √   | √     | √   |
| Read committed      | ×   | √     | √   |
| Repeatable Read(默认) | ×   | ×     | √   |
| Serializable        | ×   | ×     | ×   |
![[Pasted image 20250822211356.png]]
```mysql
-- 查看当前会话隔离级别
SELECT @@transaction_isolation;

-- 查看全局隔离级别
SELECT @@global.transaction_isolation;
#### 设置全局隔离级别
SET GLOBAL TRANSACTION ISOLATION LEVEL READ COMMITTED;

#### 设置当前会话隔离级别
SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;

#### 设置下一个事务的隔离级别
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
```

Mybatis 配置
```xml
<insert id="transferMoney" parameterType="map">
    <!-- 设置事务隔离级别为READ COMMITTED -->
    <![CDATA[
    SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
    START TRANSACTION;
    UPDATE account SET balance = balance - #{amount} WHERE user_id = #{fromId};
    UPDATE account SET balance = balance + #{amount} WHERE user_id = #{toId};
    COMMIT;
    ]]>
</insert>
```
  通过注解实现，在Transaction上增加isolation
```java
public interface AccountMapper {
    @Update("SET TRANSACTION ISOLATION LEVEL READ COMMITTED")
    void setTransactionIsolation();
    
    @Transactional(isolation = Isolation.READ_COMMITTED)
    @Update("UPDATE account SET balance = balance - #{amount} WHERE user_id = #{fromId}")
    int withdraw(@Param("fromId") int fromId, @Param("amount") BigDecimal amount);
    
    @Transactional(isolation = Isolation.READ_COMMITTED)
    @Update("UPDATE account SET balance = balance + #{amount} WHERE user_id = #{toId}")
    int deposit(@Param("toId") int toId, @Param("amount") BigDecimal amount);
}
```
或者直接在集成Mybatis时提供事务配置
```java
@Configuration
@EnableTransactionManagement
public class TransactionConfig {
    
    @Bean
    public PlatformTransactionManager transactionManager(DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
    
    @Bean
    public TransactionInterceptor transactionInterceptor() {
        Properties properties = new Properties();
        // 设置方法级别的事务属性
        properties.setProperty("transfer*", 
            "PROPAGATION_REQUIRED,ISOLATION_READ_COMMITTED,-Exception");
        return new TransactionInterceptor(transactionManager(), properties);
    }
}
```
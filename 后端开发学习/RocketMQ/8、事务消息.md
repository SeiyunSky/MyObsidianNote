![[Pasted image 20250820171116.png]]```

```java
对于生产者：
//核心改动在于:  
//1.创建一个事务型生产者  
TransactionMQProducer producer = new TransactionMQProducer("group1");  
//2.设置事务监听  
producer.setTransactionListener(  
        new TransactionListener() {  
            //正常事务的过程  
            @Override  
            public LocalTransactionState executeLocalTransaction(Message message, Object o) {  
                //正常事务完成后，返回LocalTransactionState的枚举类  
                //分别是提交，回滚和中间态  
                //可以根据数据库的状态去写对应的返回数值  
                return LocalTransactionState.COMMIT_MESSAGE;  
            }  
            //事务的补偿过程  
            @Override  
            public LocalTransactionState checkLocalTransaction(MessageExt messageExt) {  
                //事务补偿阶段去检查是否成功，再次进行一次  
                return LocalTransactionState.ROLLBACK_MESSAGE;  
                //如果这里也返回UNKNOW就需要运维来处理了  
            }  
        }  
);

```